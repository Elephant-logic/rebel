<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Commercial Break Control</title>
  <!-- Talking to the host via REBEL API BRIDGE -->
  <script src="/rebel-api-bridge.js"></script>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: #050508;
      color: #f5f5f5;
      font-size: 14px;
    }

    h1 {
      font-size: 18px;
      margin: 0 0 4px;
    }

    small {
      font-size: 11px;
      opacity: 0.7;
    }

    .section {
      border: 1px solid #222;
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 12px;
      background: rgba(10, 10, 18, 0.95);
    }

    .section strong {
      font-size: 13px;
      display: block;
      margin-bottom: 6px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }

    label {
      font-size: 12px;
      opacity: 0.85;
      min-width: 60px;
    }

    input[type="text"],
    input[type="number"],
    input[type="color"] {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      font-size: 13px;
    }

    input[type="number"] {
      width: 80px;
    }

    button {
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      background: #00c853;
      color: #000;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    button.secondary {
      background: #2979ff;
      color: #fff;
    }

    button.scene {
      background: #333;
      color: #f5f5f5;
    }

    button.scene.active {
      background: #ff4b6a;
      color: #000;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .pill {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111;
      border: 1px solid #333;
      color: #999;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <h1>Commercial Break Tool</h1>
  <small>
    Runs inside an iframe. Talks to the host overlay via <code>RebelAPI</code>
    and drives <code>commercial-overlay.html</code>.
  </small>

  <!-- Quick presets -->
  <div class="section">
    <strong>Quick presets</strong>
    <div class="row">
      <button onclick="presetBreak('Back in 5', 300)">Back in 5</button>
      <button onclick="presetBreak('Grabbing a brew', 180)">Brew break</button>
      <button onclick="presetBreak('BRB', 60)">BRB 60s</button>
      <button onclick="presetBreak('Ad Break', 120)">Ad Break 2m</button>
    </div>
  </div>

  <!-- Custom break -->
  <div class="section">
    <strong>Custom commercial</strong>
    <div class="row">
      <label for="titleInput">Title</label>
      <input id="titleInput" type="text" placeholder="Break title..." />
    </div>
    <div class="row">
      <label for="secondsInput">Seconds</label>
      <input id="secondsInput" type="number" min="5" step="5" value="60" />
      <span class="pill">drives <code>breakSeconds</code></span>
    </div>
    <div class="row">
      <label for="colorInput">Accent</label>
      <input id="colorInput" type="color" value="#ff4b6a" />
      <span class="pill">drives <code>accentColor</code></span>
    </div>
    <div class="row">
      <button class="secondary" onclick="applyCustom()">Apply</button>
      <button onclick="restartCountdown()">Restart countdown</button>
    </div>
  </div>

  <!-- Scene selection -->
  <div class="section">
    <strong>Scene</strong>
    <div class="row">
      <button id="btnSceneFull" class="scene" onclick="setScene('Full')">Full</button>
      <button id="btnSceneTicker" class="scene" onclick="setScene('Ticker')">Ticker</button>
    </div>
    <small>
      Matches <code>scenes: ["Full", "Ticker"]</code> in <code>commercial-overlay.html</code>.
    </small>
  </div>

  <!-- Optional chat helper -->
  <div class="section">
    <strong>Optional: drop a chat message</strong>
    <div class="row">
      <input id="chatInput" type="text" placeholder="e.g. Taking a 5 minute break..." style="flex: 1 1 auto;" />
      <button onclick="sendChat()">Send</button>
    </div>
    <small>Sends to host chat via <code>RebelAPI.sendChat</code> if available.</small>
  </div>

  <script>
    // --- Safe wrappers around RebelAPI ----------------------------------
    function safeSetField(key, value) {
      try {
        if (window.RebelAPI && typeof RebelAPI.setField === 'function') {
          RebelAPI.setField(key, value);
        } else {
          console.warn('RebelAPI.setField not available');
        }
      } catch (err) {
        console.error('Error calling RebelAPI.setField', err);
      }
    }

    function safeSetScene(sceneName) {
      try {
        if (window.RebelAPI && typeof RebelAPI.setScene === 'function') {
          RebelAPI.setScene(sceneName);
        } else {
          console.warn('RebelAPI.setScene not available');
        }
      } catch (err) {
        console.error('Error calling RebelAPI.setScene', err);
      }
    }

    function safeSendChat(text) {
      try {
        if (window.RebelAPI && typeof RebelAPI.sendChat === 'function') {
          RebelAPI.sendChat(text);
        } else {
          console.warn('RebelAPI.sendChat not available');
        }
      } catch (err) {
        console.error('Error calling RebelAPI.sendChat', err);
      }
    }

    // --- DOM helpers -----------------------------------------------------
    const titleInput = document.getElementById('titleInput');
    const secondsInput = document.getElementById('secondsInput');
    const colorInput = document.getElementById('colorInput');
    const chatInput = document.getElementById('chatInput');
    const btnSceneFull = document.getElementById('btnSceneFull');
    const btnSceneTicker = document.getElementById('btnSceneTicker');

    function setScene(sceneName) {
      safeSetScene(sceneName);
      // Button highlight
      btnSceneFull.classList.toggle('active', sceneName === 'Full');
      btnSceneTicker.classList.toggle('active', sceneName === 'Ticker');
    }

    function applyFields(title, seconds, accent) {
      if (title != null && title !== '') {
        safeSetField('breakTitle', title);
      }
      if (seconds != null && !Number.isNaN(seconds)) {
        safeSetField('breakSeconds', String(seconds));
      }
      if (accent != null && accent !== '') {
        safeSetField('accentColor', accent);
      }
    }

    // --- Presets / actions -----------------------------------------------

    function presetBreak(title, seconds) {
      // Use current accent color from picker
      const accent = colorInput.value || '#ff4b6a';
      titleInput.value = title;
      secondsInput.value = seconds;
      applyFields(title, seconds, accent);
      // Typically you'd want the full scene for a break
      setScene('Full');
    }

    function applyCustom() {
      const title = (titleInput.value || '').trim() || 'Be Right Back';
      const sec = parseInt(secondsInput.value, 10);
      const seconds = Number.isNaN(sec) ? 60 : sec;
      const accent = colorInput.value || '#ff4b6a';

      applyFields(title, seconds, accent);
      // Don't force scene here; let the user pick Full/Ticker
    }

    function restartCountdown() {
      // Just re-push breakSeconds; overlay script will restart from that value
      const sec = parseInt(secondsInput.value, 10);
      const seconds = Number.isNaN(sec) ? 60 : sec;
      safeSetField('breakSeconds', String(seconds));
    }

    function sendChat() {
      const msg = (chatInput.value || '').trim();
      if (!msg) return;
      safeSendChat(msg);
      chatInput.value = '';
    }

    // Default initial scene
    setScene('Full');
  </script>
</body>
</html>
